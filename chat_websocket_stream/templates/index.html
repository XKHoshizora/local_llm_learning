<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">

    <!-- PyScript å¿…éœ€çš„ CSS å’Œ JS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.10.3/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.10.3/core.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #chatlog {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 200px);
            min-height: 400px;
        }

        #chatlog::-webkit-scrollbar {
            width: 8px;
        }

        #chatlog::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #chatlog::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        #chatlog::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .input-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;       /* æ–°å¢ï¼šç»§æ‰¿å­—ä½“ */
            resize: none;                /* æ–°å¢ï¼šç¦æ­¢æ‰‹åŠ¨è°ƒæ•´å¤§å° */
            min-height: 48px;           /* æ–°å¢ï¼šæœ€å°é«˜åº¦ï¼ˆçº¦1è¡Œï¼‰ */
            max-height: 150px;          /* æ–°å¢ï¼šæœ€å¤§é«˜åº¦ï¼ˆçº¦5-6è¡Œï¼‰ */
            overflow-y: auto;           /* æ–°å¢ï¼šè¶…è¿‡æœ€å¤§é«˜åº¦åæ˜¾ç¤ºæ»šåŠ¨æ¡ */
            line-height: 1.5;           /* æ–°å¢ï¼šè¡Œé«˜ */
        }

        #user-input:focus {
            border-color: #667eea;
        }

        #send-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #send-btn:active {
            transform: translateY(0);
        }

        #send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
        #chatlog > div {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

</head>
<body>
    <h1>ğŸ¤– AI èŠå¤©æœºå™¨äºº</h1>
    <div id="chatlog"></div>
    <div class="input-container">
        <textarea id="user-input" rows="1" placeholder="åœ¨æ­¤å¤„è¾“å…¥ä½ çš„æ¶ˆæ¯..."></textarea>
        <button id="send-btn">å‘é€</button>
    </div>

    <script type="py">
        # PyScript ä»£ç å°†åœ¨æ­¤å¤„è¿è¡Œ
        from pyscript import document, window, WebSocket
        from pyodide.ffi import create_proxy, to_js
        from js import io  # Socket.IO å®¢æˆ·ç«¯
        from datetime import datetime
        import html
        import time

        # è·å– HTML å…ƒç´ 
        chatlog = document.getElementById("chatlog")
        user_input = document.getElementById("user-input")
        send_btn = document.getElementById("send-btn")
        
        # åˆå§‹åŒ– Socket.IO æ¥å£
        socket = io()

        # 
        history_messages = [{
            "role": "system",
            "content": "ä½ æ˜¯ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ç»™å‡ºå›ç­”ã€‚"
        }]

        # åœ¨ HTML ä¸­æ·»åŠ æ˜¾ç¤ºèŠå¤©è®°å½•çš„å‡½æ•°
        def display_message(role, message, message_id=None):
            """åœ¨èŠå¤©è®°å½•ä¸­æ˜¾ç¤ºæ¶ˆæ¯"""
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

            # æ ¹æ®è§’è‰²é€‰æ‹©èƒŒæ™¯é¢œè‰²ï¼ˆåŒºåˆ†ä¸‰ç§è§’è‰²ï¼‰
            if 'user' in role.lower():
                background_color = '#e3f2fd'  # è“è‰² - ç”¨æˆ·æ¶ˆæ¯
            elif 'system' in role.lower():
                background_color = '#fff3e0'  # æ©™è‰² - ç³»ç»Ÿæ¶ˆæ¯
            else:
                background_color = '#e8f5e9'  # ç»¿è‰² - AI æ¨¡å‹æ¶ˆæ¯

            # å¦‚æœæŒ‡å®šäº† message_idï¼Œè¯´æ˜æ˜¯æµå¼æ›´æ–°å·²æœ‰æ¶ˆæ¯
            if message_id:
                existing_msg = document.getElementById(f'msg-{message_id}')
                if existing_msg:
                    existing_msg.innerHTML = html.escape(message)
                    return message_id
            
            # å¦åˆ™åˆ›å»ºæ–°æ¶ˆæ¯
            if not message_id:
                message_id = str(int(time.time() * 1000))  # ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºID
            
            # æ„å»ºæ¶ˆæ¯ HTML
            message_html = f"""<div style='margin: 0.5em; padding: 0.5em; background-color: {background_color}; border-radius: 0.5em;'>
                <strong>{role.capitalize()}</strong> [{timestamp}]<br>
                <span id='msg-{message_id}'>{html.escape(message)}</span>
            </div>"""
            chatlog.innerHTML += message_html

            # è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatlog.scrollTop = chatlog.scrollHeight

            return message_id

        # å¤„ç† Socket.IO äº‹ä»¶
        def on_connect(*args):
            """è¿æ¥æˆåŠŸæ—¶æ˜¾ç¤ºæç¤º"""
            display_message("*system: ", "å·²è¿æ¥åˆ°æœåŠ¡å™¨")
        def on_disconnect(*args):
            """è¿æ¥æ–­å¼€æ—¶æ˜¾ç¤ºæç¤º"""
            display_message("*system: ", "å·²æ–­å¼€ä¸æœåŠ¡å™¨çš„è¿æ¥")
        def on_error(event):
            """å¤„ç†é”™è¯¯äº‹ä»¶"""
            display_message("*system: ", f"é”™è¯¯: {event}")
        
        # å­˜å‚¨å½“å‰æ­£åœ¨æµå¼è¾“å‡ºçš„æ¶ˆæ¯
        current_streaming_id = None
        current_streaming_content = ""
        
        def on_bot_stream_start(event):
            """å¤„ç†æµå¼è¾“å‡ºå¼€å§‹"""
            global current_streaming_id, current_streaming_content
            model_name = event.model
            current_streaming_content = ""
            # åˆ›å»ºä¸€ä¸ªç©ºæ¶ˆæ¯å ä½ç¬¦
            current_streaming_id = display_message(f"{model_name}: ", "")
        
        def on_bot_stream_chunk(event):
            """å¤„ç†æµå¼è¾“å‡ºçš„æ¯ä¸ªchunk"""
            global current_streaming_id, current_streaming_content
            chunk = event.chunk  # è·å–å½“å‰çš„æ–‡æœ¬ç‰‡æ®µ
            current_streaming_content += chunk
            # æ›´æ–°æ˜¾ç¤º
            display_message("", current_streaming_content, current_streaming_id)
        
        def on_bot_stream_end(event):
            """å¤„ç†æµå¼è¾“å‡ºç»“æŸ"""
            global current_streaming_id, current_streaming_content
            model_name = event.model
            # å°†å®Œæ•´æ¶ˆæ¯æ·»åŠ åˆ°å†å²
            history_messages.append({
                "role": "assistant",  # æ³¨æ„ï¼šä½¿ç”¨ "assistant" è€Œä¸æ˜¯æ¨¡å‹å
                "content": current_streaming_content
            })
            # é‡ç½®çŠ¶æ€
            current_streaming_id = None
            current_streaming_content = ""

        # ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
        socket.on('connect', create_proxy(on_connect))
        socket.on('disconnect', create_proxy(on_disconnect))
        socket.on('error', create_proxy(on_error))
        socket.on('bot_stream_start', create_proxy(on_bot_stream_start))
        socket.on('bot_stream_chunk', create_proxy(on_bot_stream_chunk))
        socket.on('bot_stream_end', create_proxy(on_bot_stream_end))

        def handle_send(event):
            """å¤„ç†å‘é€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶"""
            user_message = user_input.value.strip()
            if user_message:
                display_message("user: ", user_message)
                # å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å†å²æ¶ˆæ¯ä¸­
                history_messages.append({
                    "role": "user",
                    "content": user_message
                })
                # å‘é€ç”¨æˆ·æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                socket.emit('user_message', to_js({'message': history_messages}))
                user_input.value = ''
            else:
                display_message("*system: ", "è¯·è¾“å…¥æ¶ˆæ¯")
        
        # ç»‘å®šå‘é€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        send_btn.addEventListener('click', create_proxy(handle_send))

        def handle_keydown(event):
            """å¤„ç†ç”¨æˆ·è¾“å…¥çš„å›è½¦äº‹ä»¶"""
            if event.key == 'Enter' and not event.shiftKey:
                # Enterï¼ˆä¸æŒ‰Shiftï¼‰: å‘é€æ¶ˆæ¯
                event.preventDefault()  # é˜»æ­¢é»˜è®¤æ¢è¡Œ
                handle_send(event)
            # Shift+Enter: è‡ªåŠ¨æ¢è¡Œï¼ˆä¸åšå¤„ç†ï¼‰
        
        # ç»‘å®šç”¨æˆ·è¾“å…¥çš„å›è½¦äº‹ä»¶
        user_input.addEventListener('keydown', create_proxy(handle_keydown))

        def auto_resize(event):
            """è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦"""
            # å…ˆé‡ç½®é«˜åº¦ä¸º autoï¼Œè®©æµè§ˆå™¨é‡æ–°è®¡ç®—
            user_input.style.height = 'auto'
            # ç„¶åè®¾ç½®ä¸ºå®é™…å†…å®¹é«˜åº¦
            user_input.style.height = f'{user_input.scrollHeight}px'
        
        # ç»‘å®š input äº‹ä»¶ï¼Œæ¯æ¬¡è¾“å…¥æ—¶è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        user_input.addEventListener('input', create_proxy(auto_resize))
        
        # åˆå§‹åŒ–æ—¶ä¹Ÿè°ƒæ•´ä¸€æ¬¡é«˜åº¦
        auto_resize(None)
    </script>
</body>
</html>
