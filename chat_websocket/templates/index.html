<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">

    <!-- PyScript å¿…éœ€çš„ CSS å’Œ JS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.10.3/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.10.3/core.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #chatlog {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 200px);
            min-height: 400px;
        }

        #chatlog::-webkit-scrollbar {
            width: 8px;
        }

        #chatlog::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #chatlog::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        #chatlog::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .input-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #user-input:focus {
            border-color: #667eea;
        }

        #send-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #send-btn:active {
            transform: translateY(0);
        }

        #send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
        #chatlog > div {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

</head>
<body>
    <h1>ğŸ¤– AI èŠå¤©æœºå™¨äºº</h1>
    <div id="chatlog"></div>
    <div class="input-container">
        <input type="text" id="user-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥ä½ çš„æ¶ˆæ¯...">
        <button id="send-btn">å‘é€</button>
    </div>

    <script type="py">
        # PyScript ä»£ç å°†åœ¨æ­¤å¤„è¿è¡Œ
        from pyscript import document, window, WebSocket
        from pyodide.ffi import create_proxy, to_js
        from js import io  # Socket.IO å®¢æˆ·ç«¯
        from datetime import datetime
        import html

        # è·å– HTML å…ƒç´ 
        chatlog = document.getElementById("chatlog")
        user_input = document.getElementById("user-input")
        send_btn = document.getElementById("send-btn")
        
        # åˆå§‹åŒ– Socket.IO æ¥å£
        socket = io()

        # åœ¨ HTML ä¸­æ·»åŠ æ˜¾ç¤ºèŠå¤©è®°å½•çš„å‡½æ•°
        def display_message(role, message):
            """åœ¨èŠå¤©è®°å½•ä¸­æ˜¾ç¤ºæ¶ˆæ¯"""
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

            # æ ¹æ®è§’è‰²é€‰æ‹©èƒŒæ™¯é¢œè‰²ï¼ˆåŒºåˆ†ä¸‰ç§è§’è‰²ï¼‰
            if 'user' in role.lower():
                background_color = '#e3f2fd'  # è“è‰² - ç”¨æˆ·æ¶ˆæ¯
            elif 'system' in role.lower():
                background_color = '#fff3e0'  # æ©™è‰² - ç³»ç»Ÿæ¶ˆæ¯
            else:
                background_color = '#e8f5e9'  # ç»¿è‰² - AI æ¨¡å‹æ¶ˆæ¯

            # æ„å»ºæ¶ˆæ¯ HTML
            message_html = f"""<div style='margin: 0.5em; padding: 0.5em; background-color: {background_color}; border-radius: 0.5em;'>
                <strong>{role.capitalize()}</strong> [{timestamp}]<br>
                {html.escape(message)}
            </div>"""
            chatlog.innerHTML += message_html

        # å¤„ç† Socket.IO äº‹ä»¶
        def on_connect(*args):
            """è¿æ¥æˆåŠŸæ—¶æ˜¾ç¤ºæç¤º"""
            display_message("*system: ", "å·²è¿æ¥åˆ°æœåŠ¡å™¨")
        def on_disconnect(*args):
            """è¿æ¥æ–­å¼€æ—¶æ˜¾ç¤ºæç¤º"""
            display_message("*system: ", "å·²æ–­å¼€ä¸æœåŠ¡å™¨çš„è¿æ¥")
        def on_error(event):
            """å¤„ç†é”™è¯¯äº‹ä»¶"""
            display_message("*system: ", f"é”™è¯¯: {event}")
        def on_bot_response(event):
            """å¤„ç† LLM å“åº”"""
            # ç›´æ¥è®¿é—® JavaScript å¯¹è±¡çš„å±æ€§
            # è·å–æ¨¡å‹åç§°
            model_name = event.model
            response = event.response
            display_message(f"{model_name}: ", response)

        # ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
        socket.on('connect', create_proxy(on_connect))
        socket.on('disconnect', create_proxy(on_disconnect))
        socket.on('error', create_proxy(on_error))
        socket.on('bot_response', create_proxy(on_bot_response))

        def handle_send(event):
            """å¤„ç†å‘é€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶"""
            user_message = user_input.value.strip()
            if user_message:
                display_message("user: ", user_message)
                socket.emit('user_message', to_js({'message': user_message}))
                user_input.value = ''
            else:
                display_message("*system: ", "è¯·è¾“å…¥æ¶ˆæ¯")
        
        # ç»‘å®šå‘é€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        send_btn.addEventListener('click', create_proxy(handle_send))

        def handle_keydown(event):
            """å¤„ç†ç”¨æˆ·è¾“å…¥çš„å›è½¦äº‹ä»¶"""
            if event.key == 'Enter':
                handle_send(event)
        
        # ç»‘å®šç”¨æˆ·è¾“å…¥çš„å›è½¦äº‹ä»¶
        user_input.addEventListener('keydown', create_proxy(handle_keydown))
    </script>
</body>
</html>
